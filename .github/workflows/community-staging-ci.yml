name: CI (Staging)

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:

concurrency:
    group: ci-staging-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    security-events: write
    checks: write
    pull-requests: write

defaults:
    run:
        shell: bash

env:
    PYTHONUNBUFFERED: "1"
    PIP_DISABLE_PIP_VERSION_CHECK: "1"
    POETRY_VIRTUALENVS_IN_PROJECT: "true"
    COVERAGE_THRESHOLD: ${{ vars.COVERAGE_THRESHOLD || 55 }}

jobs:
    lint:
        name: Code Quality
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  version: "1.8.3"
                  virtualenvs-in-project: true
                  virtualenvs-create: true

            - name: Ensure poetry.lock matches pyproject.toml
              run: poetry lock --no-interaction --no-update

            - name: Cache Poetry downloads
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/pypoetry
                      ~/.cache/pip
                  key: poetry-${{ runner.os }}-lint-3.10-${{ hashFiles('poetry.lock') }}
                  restore-keys: |
                      poetry-${{ runner.os }}-lint-3.10-

            - name: Cache virtual environment
              uses: actions/cache@v4
              with:
                  path: .venv
                  key: venv-${{ runner.os }}-lint-3.10-${{ hashFiles('poetry.lock') }}
                  restore-keys: |
                      venv-${{ runner.os }}-lint-3.10-

            - name: Install dependencies
              run: poetry install --with dev --no-interaction --no-root

            - name: Run Ruff for linting and import sorting
              run: poetry run ruff check . --output-format=github --fix

            - name: Auto-format with Black (staging keeps tree tidy)
              run: poetry run black .

            - name: Verify formatting
              run: poetry run black --check .

            - name: Run Mypy for type checking
              run: poetry run mypy

    test:
        name: Unit Tests
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      python-version: "3.10"
                      coverage: true
                      shard: "1"
                    - os: ubuntu-latest
                      python-version: "3.10"
                      coverage: true
                      shard: "2"
                    - os: ubuntu-latest
                      python-version: "3.10"
                      coverage: true
                      shard: "3"
                    - os: macos-latest
                      python-version: "3.10"
                      coverage: true
                      shard: "macos"
                    - os: windows-latest
                      python-version: "3.10"
                      coverage: false
                      shard: "windows"
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  version: "1.8.3"
                  virtualenvs-in-project: true
                  virtualenvs-create: true

            - name: Ensure poetry.lock matches pyproject.toml
              run: poetry lock --no-interaction --no-update

            - name: Cache Poetry downloads
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/pypoetry
                      ~/.cache/pip
                  key: poetry-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('poetry.lock') }}
                  restore-keys: |
                      poetry-${{ runner.os }}-${{ matrix.python-version }}-

            - name: Cache virtual environment
              uses: actions/cache@v4
              with:
                  path: .venv
                  key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('poetry.lock') }}
                  restore-keys: |
                      venv-${{ runner.os }}-${{ matrix.python-version }}-

            - name: Install dependencies
              run: poetry install --with dev --no-interaction --no-root

            - name: Run tests
              shell: bash
              run: |
                  if [ "${{ matrix.coverage }}" = "true" ]; then
                    poetry run pytest \
                      --cov=src \
                      --cov-report=term \
                      --cov-report=xml:coverage-${{ matrix.python-version }}-${{ matrix.os }}-${{ matrix.shard }}.xml \
                      --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}
                  else
                    poetry run pytest --maxfail=1 --disable-warnings
                  fi

            - name: Prepare coverage artifact
              if: ${{ matrix.coverage }}
              shell: bash
              run: |
                  mv .coverage ".coverage.${{ matrix.python-version }}.${{ matrix.os }}.${{ matrix.shard }}"

            - name: Upload coverage data
              if: ${{ matrix.coverage }}
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-data-${{ matrix.python-version }}-${{ matrix.os }}-${{ matrix.shard }}
                  path: ".coverage.${{ matrix.python-version }}.${{ matrix.os }}.${{ matrix.shard }}"
                  overwrite: true

            - name: Upload coverage report
              if: ${{ matrix.coverage }}
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-xml-${{ matrix.python-version }}-${{ matrix.os }}-${{ matrix.shard }}
                  path: coverage-${{ matrix.python-version }}-${{ matrix.os }}-${{ matrix.shard }}.xml
                  overwrite: true

    coverage-aggregate:
        name: Aggregate Coverage
        needs: test
        runs-on: ubuntu-latest
        if: ${{ always() }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download coverage data
              uses: actions/download-artifact@v4
              with:
                  pattern: coverage-data-*
                  path: coverage-data
                  merge-multiple: true

            - name: Download coverage reports
              uses: actions/download-artifact@v4
              with:
                  pattern: coverage-xml-*
                  path: coverage-xml
                  merge-multiple: true

            - name: Merge coverage files
              id: combine
              shell: bash
              run: |
                  set -euo pipefail
                  python -m pip install --upgrade pip coverage

                  mapfile -t files < <(find coverage-data -type f -name '.coverage.*' -print)
                  if [ "${#files[@]}" -eq 0 ]; then
                    echo "has_data=false" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  idx=0
                  for file in "${files[@]}"; do
                    idx=$((idx+1))
                    dest=".coverage.${idx}"
                    cp "$file" "$dest"
                  done

                  coverage combine .coverage.*
                  coverage xml -o coverage.xml
                  coverage report --fail-under=${{ env.COVERAGE_THRESHOLD }}

                  echo "has_data=true" >> "$GITHUB_OUTPUT"

            - name: Upload merged coverage
              if: steps.combine.outputs.has_data == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-final
                  path: coverage.xml

    security:
        name: Security Analysis
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  version: "1.8.3"
                  virtualenvs-in-project: true
                  virtualenvs-create: true

            - name: Ensure poetry.lock matches pyproject.toml
              run: poetry lock --no-interaction --no-update

            - name: Cache Poetry downloads
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/pypoetry
                      ~/.cache/pip
                  key: poetry-${{ runner.os }}-security-3.10-${{ hashFiles('poetry.lock') }}
                  restore-keys: |
                      poetry-${{ runner.os }}-security-3.10-

            - name: Cache virtual environment
              uses: actions/cache@v4
              with:
                  path: .venv
                  key: venv-${{ runner.os }}-security-3.10-${{ hashFiles('poetry.lock') }}
                  restore-keys: |
                      venv-${{ runner.os }}-security-3.10-

            - name: Install dependencies
              run: poetry install --with dev --no-interaction --no-root

            - name: Run pip-audit for dependency vulnerabilities
              run: |
                  poetry run python -m pip install --upgrade pip
                  poetry run pip uninstall -y community-staging || true
                  # Temporary ignore until pip releases a fix for GHSA-4xh5-x5gv-qwph
                  poetry run pip-audit --strict --skip-editable --ignore-vuln GHSA-4xh5-x5gv-qwph

            - name: Run Bandit for static analysis
              run: poetry run bandit -r src -ll

            - name: Run Trivy for filesystem vulnerabilities
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: fs
                  severity: HIGH,CRITICAL
                  exit-code: "1"

    package-dist:
        name: Package Distribution Artifact
        needs:
            - lint
            - test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Determine core SHA from source metadata
              id: meta
              shell: bash
              run: |
                  set -euo pipefail
                  FILE=.rapidkit/source.json
                  if [ -f "$FILE" ]; then
                    CORE_SHA=$(python3 -c "import json;print(json.load(open('.rapidkit/source.json')).get('core_sha','unknown'))" 2>/dev/null || echo "unknown")
                    echo "core_sha=$CORE_SHA" >> $GITHUB_OUTPUT
                    echo "Detected core_sha=$CORE_SHA"
                  else
                    echo "⚠️ .rapidkit/source.json not found; using repo HEAD"
                    CORE_SHA=$(git rev-parse HEAD)
                    echo "core_sha=$CORE_SHA" >> $GITHUB_OUTPUT
                  fi

            - name: Create distribution tarball
              shell: bash
              run: |
                  set -e
                  NAME="dist-${{ steps.meta.outputs.core_sha }}.tar.gz"
                  TAR_OUT="$RUNNER_TEMP/$NAME"
                  echo "Packaging repository into $NAME ..."
                  tar -czf "$TAR_OUT" \
                    --exclude .git \
                    --exclude=./.github/workflows \
                    --exclude=./.github/actions \
                    --exclude venv \
                    --exclude .venv \
                    -C . .
                  ls -lh "$TAR_OUT"

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: dist-${{ steps.meta.outputs.core_sha }}
                  path: ${{ runner.temp }}/dist-${{ steps.meta.outputs.core_sha }}.tar.gz
                  retention-days: 7

    aggregate:
        name: CI Summary
        needs:
            - lint
            - test
            - coverage-aggregate
            - security
            - package-dist
        runs-on: ubuntu-latest
        steps:
            - name: Print CI summary
              run: |
                  echo "Staging CI completed! Coverage threshold: ${{ env.COVERAGE_THRESHOLD }}%"
