name: "ðŸš€ Promote Staging â†’ Core (PR-based; keep core workflows)"

on:
    workflow_dispatch:
        inputs:
            source_ref:
                description: "Staging ref to promote (tag/branch/SHA). Example: v1.8.0"
                required: true
                type: string
            target_repo:
                description: "Target core repo (owner/name)"
                required: true
                default: "getrapidkit/rapidkit-core"
                type: string
            target_branch:
                description: "Target branch in core"
                required: true
                default: "main"
                type: string
            promote_branch:
                description: "Branch name to create in core"
                required: true
                default: ""
                type: string
            create_pr:
                description: "Create PR in core automatically"
                required: true
                default: "true"
                type: choice
                options:
                    - "true"
                    - "false"
            dry_run:
                description: "Validate only; do not push / create PR"
                required: true
                default: "false"
                type: choice
                options:
                    - "false"
                    - "true"

concurrency:
    group: community-staging-promote-to-core-pr-${{ github.ref }}
    cancel-in-progress: true

jobs:
    promote:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout staging
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: true
                  persist-credentials: false

            - name: Remove checkout auth header
              run: |
                  set -euo pipefail
                  git config --local --unset-all http.https://github.com/.extraheader || true

            - name: Configure git
              run: |
                  set -euo pipefail
                  git config --global user.name "rapidkit-bot"
                  git config --global user.email "actions@users.noreply.github.com"

            - name: Resolve promote branch name
              id: branch
              run: |
                  set -euo pipefail
                  src_ref="${{ inputs.source_ref }}"
                  custom="${{ inputs.promote_branch }}"
                  if [[ -n "$custom" ]]; then
                      b="$custom"
                  else
                      safe="$src_ref"
                      safe="${safe//\//-}"
                      safe="${safe// /-}"
                      safe="${safe//:/-}"
                      safe="${safe//#/}"
                      b="promote/${safe}"
                  fi
                  echo "branch=$b" >> "$GITHUB_OUTPUT"

            - name: Add core remote
              env:
                  CORE_PUSH_TOKEN: ${{ secrets.CORE_PUSH_TOKEN }}
                  TARGET_REPO: ${{ inputs.target_repo }}
              run: |
                  set -euo pipefail
                  if [[ -z "${CORE_PUSH_TOKEN:-}" ]]; then
                      echo "Missing CORE_PUSH_TOKEN secret" >&2
                      echo "Create a fine-grained PAT with permissions: Contents=Read/Write, Pull requests=Read/Write (for target repo)." >&2
                      exit 1
                  fi
                  remote_url="https://x-access-token:${CORE_PUSH_TOKEN}@github.com/${TARGET_REPO}.git"
                  if git remote get-url core >/dev/null 2>&1; then
                      git remote set-url core "$remote_url"
                  else
                      git remote add core "$remote_url"
                  fi

            - name: Validate token can access target repo
              env:
                  CORE_PUSH_TOKEN: ${{ secrets.CORE_PUSH_TOKEN }}
                  TARGET_REPO: ${{ inputs.target_repo }}
              run: |
                  set -euo pipefail
                  code=$(curl -sS -o /dev/null -w "%{http_code}" \
                    -H "Authorization: Bearer ${CORE_PUSH_TOKEN}" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    "https://api.github.com/repos/${TARGET_REPO}")
                  echo "Token repo metadata access check for ${TARGET_REPO}: HTTP ${code}"
                  if [[ "${code}" != "200" ]]; then
                      echo "Token cannot access target repo via API (expected 200)." >&2
                      exit 1
                  fi

            - name: Fetch core branch
              env:
                  TARGET_BRANCH: ${{ inputs.target_branch }}
              run: |
                  set -euo pipefail
                  git fetch core "${TARGET_BRANCH}" --prune

            - name: Create promote branch from source ref
              env:
                  SOURCE_REF: ${{ inputs.source_ref }}
                  PROMOTE_BRANCH: ${{ steps.branch.outputs.branch }}
              run: |
                  set -euo pipefail
                  git checkout -B "${PROMOTE_BRANCH}" "${SOURCE_REF}"

            - name: Keep core workflows authoritative
              env:
                  TARGET_BRANCH: ${{ inputs.target_branch }}
              run: |
                  set -euo pipefail

                  # Replace staging workflows with the core repo workflows so rapidkit-core Actions stays clean.
                  if git cat-file -e "core/${TARGET_BRANCH}:.github/workflows" 2>/dev/null; then
                      git checkout "core/${TARGET_BRANCH}" -- .github/workflows
                  else
                      rm -rf .github/workflows || true
                  fi

                  if ! git diff --quiet -- .github/workflows 2>/dev/null; then
                      git add -A .github/workflows
                      git commit -m "chore: keep core GitHub workflows"
                  else
                      echo "Workflows already match core/${TARGET_BRANCH}."
                  fi

            - name: Show summary
              env:
                  SOURCE_REF: ${{ inputs.source_ref }}
                  TARGET_REPO: ${{ inputs.target_repo }}
                  TARGET_BRANCH: ${{ inputs.target_branch }}
                  PROMOTE_BRANCH: ${{ steps.branch.outputs.branch }}
              run: |
                  set -euo pipefail
                  echo "Source ref (staging): ${SOURCE_REF}"
                  echo "Promote branch: ${PROMOTE_BRANCH}"
                  echo "Target: ${TARGET_REPO}:${TARGET_BRANCH}"
                  echo "Promote HEAD: $(git rev-parse --short=12 HEAD)"

            - name: Push promote branch to core
              if: ${{ inputs.dry_run != 'true' }}
              env:
                  PROMOTE_BRANCH: ${{ steps.branch.outputs.branch }}
                  TARGET_BRANCH: ${{ inputs.target_branch }}
              run: |
                  set -euo pipefail
                  git push core "HEAD:${PROMOTE_BRANCH}"

            - name: Create PR in core
              if: ${{ inputs.dry_run != 'true' && inputs.create_pr == 'true' }}
              env:
                  CORE_PUSH_TOKEN: ${{ secrets.CORE_PUSH_TOKEN }}
                  TARGET_REPO: ${{ inputs.target_repo }}
                  TARGET_BRANCH: ${{ inputs.target_branch }}
                  SOURCE_REF: ${{ inputs.source_ref }}
                  PROMOTE_BRANCH: ${{ steps.branch.outputs.branch }}
              run: |
                  set -euo pipefail

                  owner="${TARGET_REPO%%/*}"
                  repo="${TARGET_REPO##*/}"
                  head="${owner}:${PROMOTE_BRANCH}"

                  title="Promote ${SOURCE_REF} â†’ ${TARGET_BRANCH}"
                  body=$'Automated promote from staging ref '\''${SOURCE_REF}'\''.'"\n\n"$'- Keeps rapidkit-core workflows authoritative by restoring .github/workflows from '\''${TARGET_BRANCH}'\''.'

                  payload_file="$(mktemp)"
                  resp_file="$(mktemp)"
                  cleanup() { rm -f "$payload_file" "$resp_file"; }
                  trap cleanup EXIT

                  TITLE="$title" HEAD="$head" BASE="$TARGET_BRANCH" BODY="$body" \
                      python3 -c 'import json, os; print(json.dumps({"title": os.environ["TITLE"], "head": os.environ["HEAD"], "base": os.environ["BASE"], "body": os.environ["BODY"]}))' \
                      > "$payload_file"

                  code=$(curl -sS -o "$resp_file" -w "%{http_code}" \
                      -H "Authorization: Bearer ${CORE_PUSH_TOKEN}" \
                      -H "X-GitHub-Api-Version: 2022-11-28" \
                      -H "Content-Type: application/json" \
                      -d @"$payload_file" \
                      "https://api.github.com/repos/${owner}/${repo}/pulls")

                  if [[ "$code" = "201" ]]; then
                      url=$(python3 -c 'import json; print(json.load(open("'"$resp_file"'"))["html_url"])')
                      echo "Created PR: $url"
                      exit 0
                  fi

                  if [[ "$code" = "422" ]]; then
                      existing=$(curl -sS \
                          -H "Authorization: Bearer ${CORE_PUSH_TOKEN}" \
                          -H "X-GitHub-Api-Version: 2022-11-28" \
                          "https://api.github.com/repos/${owner}/${repo}/pulls?state=open&head=${head}&base=${TARGET_BRANCH}" \
                          | python3 -c 'import json,sys; prs=json.load(sys.stdin); print(prs[0]["html_url"] if prs else "")')
                      if [[ -n "$existing" ]]; then
                          echo "PR already exists: $existing"
                          exit 0
                      fi
                  fi

                  echo "PR create returned HTTP $code" >&2
                  cat "$resp_file" >&2 || true
                  echo "If a PR already exists for this branch, open it from the rapidkit-core UI." >&2
                  exit 0
