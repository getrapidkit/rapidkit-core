name: "ðŸš€ Promote Staging â†’ Community (Fast-forward History)"

on:
    workflow_dispatch:
        inputs:
            target_repo:
                description: "Target community repo (owner/name)"
                required: true
                default: "getrapidkit/rapidkit-core"
                type: string
            target_branch:
                description: "Target branch"
                required: true
                default: "main"
                type: string
            dry_run:
                description: "Validate only; do not push"
                required: true
                default: "false"
                type: choice
                options:
                    - "false"
                    - "true"

concurrency:
    group: community-staging-promote-ff-${{ github.ref }}
    cancel-in-progress: true

jobs:
    promote:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout staging
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Configure git
              run: |
                  set -euo pipefail
                  git config --global user.name "rapidkit-bot"
                  git config --global user.email "actions@users.noreply.github.com"

            - name: Add community remote
              env:
                  COMMUNITY_PUSH_TOKEN: ${{ secrets.COMMUNITY_PUSH_TOKEN }}
                  TARGET_REPO: ${{ inputs.target_repo }}
              run: |
                  set -euo pipefail
                  if [[ -z "$COMMUNITY_PUSH_TOKEN" ]]; then
                      echo "Missing COMMUNITY_PUSH_TOKEN secret" >&2
                      exit 1
                  fi
                  remote_url="https://x-access-token:${COMMUNITY_PUSH_TOKEN}@github.com/${TARGET_REPO}.git"
                  if git remote get-url community >/dev/null 2>&1; then
                      git remote set-url community "$remote_url"
                  else
                      git remote add community "$remote_url"
                  fi

            - name: Validate token can access target repo
              env:
                  COMMUNITY_PUSH_TOKEN: ${{ secrets.COMMUNITY_PUSH_TOKEN }}
                  TARGET_REPO: ${{ inputs.target_repo }}
              run: |
                  set -euo pipefail
                  if [[ -z "$COMMUNITY_PUSH_TOKEN" ]]; then
                      echo "Missing COMMUNITY_PUSH_TOKEN secret" >&2
                      exit 1
                  fi
                  # Validate via GitHub API using repo metadata access (does not print token)
                  code=$(curl -sS -o /dev/null -w "%{http_code}" \
                    -H "Authorization: Bearer ${COMMUNITY_PUSH_TOKEN}" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    "https://api.github.com/repos/${TARGET_REPO}")
                  echo "Token repo metadata access check for ${TARGET_REPO}: HTTP ${code}"
                  if [[ "${code}" != "200" ]]; then
                      echo "Token cannot access target repo via API (expected 200)." >&2
                      echo "Common causes: wrong owner/repo, fine-grained token not org-scoped/approved, or missing permissions." >&2
                      exit 1
                  fi

            - name: Fetch community branch
              env:
                  TARGET_BRANCH: ${{ inputs.target_branch }}
              run: |
                  set -euo pipefail
                  if git ls-remote --exit-code --heads community "${TARGET_BRANCH}" >/dev/null 2>&1; then
                      git fetch community "${TARGET_BRANCH}" --prune
                  else
                      echo "Target branch '${TARGET_BRANCH}' not found in community repo; fetching all refs." >&2
                      git fetch community --prune
                  fi

            - name: Verify fast-forward
              env:
                  TARGET_BRANCH: ${{ inputs.target_branch }}
              run: |
                  set -euo pipefail
                  if git show-ref --verify --quiet "refs/remotes/community/${TARGET_BRANCH}"; then
                      if ! git merge-base --is-ancestor "community/${TARGET_BRANCH}" HEAD; then
                          echo "Community branch is not an ancestor of staging HEAD. Refusing to push." >&2
                          exit 1
                      fi
                  else
                      echo "Target branch not found in community repo; will create it." >&2
                  fi

            - name: Show promote summary
              env:
                  TARGET_BRANCH: ${{ inputs.target_branch }}
              run: |
                  set -euo pipefail
                  echo "Staging HEAD: $(git rev-parse --short=12 HEAD)"
                  if git show-ref --verify --quiet "refs/remotes/community/${TARGET_BRANCH}"; then
                      echo "Community branch: community/${TARGET_BRANCH} ($(git rev-parse --short=12 community/${TARGET_BRANCH}))"
                      echo "Commits that would be added to community/${TARGET_BRANCH}:"
                      git log --oneline "community/${TARGET_BRANCH}..HEAD" | head -n 50 || true
                      echo "Ahead/behind counts (community...HEAD):"
                      git rev-list --left-right --count "community/${TARGET_BRANCH}...HEAD"
                      echo "NOTE: Fast-forward promote updates the full repo history (including .github)."
                  else
                      echo "Community branch community/${TARGET_BRANCH} does not exist; it will be created at staging HEAD."
                      echo "NOTE: This will create the branch with the full repo content (including .github)."
                  fi

            - name: Push history to community
              if: ${{ inputs.dry_run != 'true' }}
              env:
                  COMMUNITY_PUSH_TOKEN: ${{ secrets.COMMUNITY_PUSH_TOKEN }}
                  TARGET_REPO: ${{ inputs.target_repo }}
                  TARGET_BRANCH: ${{ inputs.target_branch }}
              run: |
                  set -euo pipefail
                  if [[ -z "$COMMUNITY_PUSH_TOKEN" ]]; then
                      echo "Missing COMMUNITY_PUSH_TOKEN secret" >&2
                      exit 1
                  fi
                  # Use the configured remote to avoid any credential ambiguity
                  git push community HEAD:"${TARGET_BRANCH}"
